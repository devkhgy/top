<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>线路侦测中</title>
  </head>
  <body></body>
  <script type="text/javascript">
    // 原壹支付充值 api 响应内容，直接从后端响应给前端的资料 Start
    var response = {
      error_code: 200,
      data: {
        order_amount: 10.01,
        request_amount: 10.01,
        url: [
          'https://domain1.com/login?token=xxxxxx',
          'https://domain2.com/login?token=xxxxxx',
          'https://domain3.com/login?token=xxxxxx'
        ],
        token: 'xxxxxx'
      }
    }
    // 原壹支付充值 api 响应内容，直接从后端响应给前端的资料 End
    var url = response.data.url
    var hostData = url.map(function(url) {
      var exUrl = url.split('/')
      return exUrl[0] + '//' + exUrl[2]
    })
    function imgLoad() {
      this.errCount = 0 // 错误计数
      this.retryCount = 0 // 目前已 retry 次数
      this.maxRetry = 5 // 最大 retry 次数
      this.errorMessage = '所有线路异常，请稍后再试。' // 测速错误时讯息
      this.count = hostData.length
      this.imgNotLoad = true
      this.imgonLoad = this.imgonLoad.bind(this)
      this.imgonLoadError = this.imgonLoadError.bind(this)
      this.reset = this.reset.bind(this)
      this.test = this.test.bind(this)
      this.img = []
      this.test()
    }
    imgLoad.prototype = {
      reset: function() {
        this.retryCount++
        this.errCount = 0
        this.imgNotLoad = true
        this.img = []
        this.test()
      },
      // 测速
      test: function() {
        var imgPath = '/images/bg.jpg' // 充值网的图片档可择一进行测速。
        for (var i = 0; i < this.count; i++) {
          this.img[i] = new Image()
          this.img[i].onload = this.imgonLoad.bind(this, url[i])
          this.img[i].onerror = this.imgonLoadError
          this.img[i].src = hostData[i] + imgPath + '?time=' + +new Date()
        }
      },
      // 图片读取后，超连结到指定网站
      imgonLoad: function(url) {
        if (this.imgNotLoad) {
          this.imgNotLoad = false
          window.location.href = url
        }
      },
      // 载入图片错误时处理
      imgonLoadError: function(b) {
        if (++this.errCount === this.count) {
          if (this.retryCount < this.maxRetry) {
            this.reset()
          } else {
            alert(this.errorMessage)
          }
        }
      }
    }
    new imgLoad()
  </script>
</html>
